## **Kaggle RentHop — Validation, Feature Selection & Hyperparameter Tuning (Краткое ТЗ)**

В этой главе продолжаем работу с задачей прогнозирования стоимости аренды квартир (RentHop, Kaggle).  
Основные цели:

- реализовать все схемы валидации,
- провести отбор признаков разными методами,
- выполнить ручной и автоматический подбор гиперпараметров,
- сравнить качество моделей и устойчивость подходов.

---

### **1. Теоретические вопросы**

В ноутбуке необходимо кратко объяснить:

- что такое **Leave-One-Out**, его ограничения и преимущества;
- как работают **Grid Search**, **Randomized Grid Search** и **Байесовская оптимизация**;
- классификацию методов отбора признаков:
  - фильтровые (filter),
  - обёрточные (wrapper),
  - встроенные (embedded);
- как работают **Pearson** и **Chi2** для отбора признаков;
- механизм отбора признаков в **Lasso** (L1 → зануление весов);
- что такое **Permutation Importance**;
- знакомство с **SHAP** и интерпретацией модели.

---

### **2. Препроцессинг данных**

Повторить подготовку данных из предыдущего урока:

- загрузить все данные train/test;
- закодировать `interest_level`;
- создать бинарные признаки (топ-20):
  `Elevator`, `HardwoodFloors`, `CatsAllowed`, `DogsAllowed`, `Doorman`,  
  `Dishwasher`, `NoFee`, `LaundryinBuilding`, `FitnessCenter`, `Pre-War`,  
  `LaundryinUnit`, `RoofDeck`, `OutdoorSpace`, `DiningRoom`, `HighSpeedInternet`,  
  `Balcony`, `SwimmingPool`, `LaundryInBuilding`, `NewConstruction`, `Terrace`.

---

### **3. Реализация методов разбиения данных**

Реализовать функции:

1. **Random train/test split**  
   Вход: `test_size`  
   Выход: train, test

2. **Random train/val/test split (60/20/20 или любые параметры)**  
   Вход: `validation_size`, `test_size`

3. **Date-based train/test split**  
   Вход: `date_split`

4. **Date-based train/val/test split**  
   Вход: `validation_date`, `test_date`

5. **Сделать разбиение детерминированным**  
   (фиксировать seed, чтобы разбиения были воспроизводимыми)

---

### **4. Реализация всех видов Cross-Validation**

Нужно реализовать:

- **K-Fold**  
  Параметр: `k`

- **Grouped K-Fold**  
  Параметры: `k`, `group_field`

- **Stratified K-Fold**  
  Параметры: `k`, `stratify_field`

- **Time Series Split**  
  Параметры: `k`, `date_field`

Каждая функция должна возвращать **список пар (train_idx, test_idx)**.

---

### **5. Сравнение Cross-Validation схем**

- применить **все реализованные схемы** к датасету;
- применить соответствующие методы из sklearn;
- сравнить распределение фичей в `train` для каждой CV-схемы;
- выбрать **лучшую схему** и обосновать выбор.

---

### **6. Feature Selection (отбор признаков)**

Нужно реализовать и сравнить несколько подходов:

#### **6.1 Lasso Feature Selection**
- нормализовать признаки;
- выполнить разбиение 60/20/20 по полю (датовое);
- обучить Lasso;
- отсортировать признаки по абсолютным значениям коэффициентов;
- взять **top-10**, переобучить модель и измерить качество.

#### **6.2 Отбор признаков по nan-ratio и корреляции**
- вычислить долю пропусков по каждому признаку;
- оценить корреляцию с целевой переменной;
- выбрать top-10 признаков;
- переобучить модель и измерить качество.

#### **6.3 Permutation Importance**
- вычислить permutation importance;
- выбрать top-10;
- переобучить модель.

#### **6.4 SHAP**
- рассчитать SHAP-значения;
- выбрать top-10 признаков;
- переобучить модель.

Сравнить методы по:
- скорости,
- качеству метрик,
- стабильности результатов.

---

### **7. Подбор гиперпараметров**

#### **7.1 Реализовать вручную**
Для `sklearn.ElasticNet`:

- **Grid Search** (по `alpha` и `l1_ratio`)
- **Random Search**

Найти лучшую комбинацию гиперпараметров и обучить итоговую модель.

#### **7.2 Оптимизация через Optuna**
- построить аналогичную оптимизацию для ElasticNet;
- сравнить с Grid/Random Search;
- запустить Optuna поверх одной из схем cross-validation.

---

### **8. Финальный анализ**

- вывести таблицы метрик (MAE / RMSE / R²);
- определить:
  - лучшую модель,
  - лучшую схему валидации,
  - лучший метод отбора признаков,
  - лучший способ подбора гиперпараметров.

